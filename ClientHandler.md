ClientHandler 클래스는 Java로 작성된 간단한 웹 애플리케이션 서버에서 클라이언트 요청을 처리하는 역할을 합니다. 이 서버는 정적 파일 제공과 서블릿을 통한 동적 콘텐츠 처리를 모두 지원합니다.

주요 기능

	1.	멀티스레드 요청 처리: Runnable을 구현하여 각 클라이언트 요청을 별도의 스레드에서 처리합니다. 이로 인해 다중 클라이언트 요청을 동시에 처리할 수 있습니다.
	2.	HTTP 요청 파싱: 클라이언트로부터 들어오는 HTTP 요청을 파싱하여 메소드(GET, POST 등), 경로, 호스트, 그리고 쿼리 파라미터를 추출합니다.
	3.	서블릿 요청 처리: 요청된 경로가 서블릿에 해당하는 경우, 해당 서블릿 클래스를 동적으로 로드하여 service 메서드를 호출해 동적 콘텐츠를 처리합니다.
	4.	정적 파일 처리:
	•	서버가 실행되는 환경이 JAR 파일인지, 파일 시스템인지 확인한 후 요청된 파일을 적절히 처리합니다.
	•	경로 보안 및 파일 접근 권한을 체크하여 불법적인 접근을 막습니다(예: ..를 사용한 디렉토리 역참조).
	•	파일이 존재하지 않거나 접근이 금지된 경우 적절한 에러 페이지를 반환합니다.
	5.	JAR 파일 시스템 캐싱: JAR 파일 내의 리소스에 대한 접근을 효율적으로 처리하기 위해 FileSystem 객체를 캐싱하여 불필요한 반복 생성을 방지합니다.
	6.	에러 처리 및 응답: 403(Forbidden), 404(Not Found), 500(Internal Server Error) 등의 오류 발생 시, 미리 설정된 에러 페이지를 응답합니다.

코드의 주요 부분 설명

	•	HTTP 요청 파싱 (parseRequest): 클라이언트 요청을 읽어 HTTP 메서드, 경로, 호스트 정보, 쿼리 파라미터 등을 파싱합니다.
	•	서블릿 요청 처리 (handleServletRequest): 서블릿이 설정된 경로라면, 해당 서블릿 클래스를 로드하여 동적 처리를 수행합니다.
	•	정적 파일 처리 (handleStaticFileRequest):
	•	서버가 JAR 파일로 패키징되어 실행 중인지 확인합니다.
	•	요청된 파일 경로를 적절히 처리하여 파일이 존재하는지 확인한 후, 응답으로 파일을 전송합니다.
	•	파일 접근이 허용되지 않거나 디렉토리 접근인 경우, 403 오류를 반환합니다.
	•	JAR 파일 시스템 관리 (getJarFileSystem): JAR 파일 내의 파일 시스템을 캐싱하여 동일한 리소스에 반복 접근 시 성능을 개선합니다.
	•	경로 보안: 경로를 정규화하고 검증하여 악의적인 경로 접근을 차단합니다.
	•	파일 전송 (serveFile): 파일의 MIME 타입을 결정하고, 응답 스트림에 파일을 전송합니다.

개선 가능성

	1.	스레드 안전성: 이미 ConcurrentHashMap을 사용하여 캐시를 관리하고 있지만, 더 복잡한 데이터 관리가 필요한 경우 추가적인 동기화 처리가 필요할 수 있습니다.
	2.	에러 로그 개선: 에러 로그를 더 구체적으로 기록하여 문제 발생 시 디버깅을 쉽게 할 수 있습니다.
	3.	리소스 관리: 스트림과 같은 리소스를 모든 예외 상황에서도 안전하게 닫도록 처리하는 것이 중요합니다.
	4.	보안 로그: 불법적인 접근 시도에 대해 보안 로그를 남겨 추후 감사나 분석에 활용할 수 있습니다.

결론

이 ClientHandler 클래스는 경량 웹 서버의 핵심 컴포넌트로, 정적 파일 제공과 동적 콘텐츠 처리를 효율적으로 수행합니다. JAR 환경과 파일 시스템 환경을 모두 고려하여 리소스를 처리하며, 경로 보안, 캐싱, 에러 처리 등 다양한 기능을 통해 안정적인 서버 운영을 지원합니다.